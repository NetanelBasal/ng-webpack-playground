#!/usr/bin/env node
const fs=require("fs"),inquirer=require("inquirer"),find=require("find"),glob=require("glob"),[localLang]=require("os-locale").sync().split("-"),messages=require("./messages").getMessages(localLang),{mergeDeep:mergeDeep,buildObjFromPath:buildObjFromPath,isObject:isObject,toCamelCase:toCamelCase,countKeysRecursively:countKeysRecursively,getLogger:getLogger}=require("./helpers"),{regexs:regexs}=require("./regexs");let spinner;const TEMPLATE_TYPE={STRUCTURAL:0,NG_TEMPLATE:1},queries=e=>[{type:"directory",name:"src",message:messages.src,basePath:e},{type:"directory",name:"output",message:messages.output,basePath:e},{type:"confirm",default:!1,name:"hasScope",message:messages.hasScope},{type:"file-tree-selection",name:"configPath",messages:messages.config,when:({hasScope:e})=>e},{type:"input",default:`en${"en"!==localLang?", "+localLang:""}`,name:"langs",message:messages.langs},{type:"input",name:"keepFlat",message:messages.keepFlat},{type:"input",name:"defaultValue",default:'""',message:messages.defaultValue}],defaultConfig={src:"src",output:"assets/i18n",langs:"en",defaultValue:""};let logger;function getTemplateBasedKeys(e,s){let t,r,a,l;const[n]=e;return s===TEMPLATE_TYPE.STRUCTURAL?(l=e.groups.varName,a=n.match(/read:\s*(?:'|")(?<read>[a-zA-Z-0-9-_]*)(?:'|")/)):(l=n.match(/let-(?<varName>\w*)/).groups.varName,a=n.match(/(?:\[?read\]?=\s*(?:'|"){1,2}(?<read>[a-zA-Z-0-9-_]*)(?:'|"){1,2})/)),{scopeKeys:t=n.match(regexs.templateKey(l)),read:r=a&&a.groups.read,varName:l}}function readFile(e){return fs.readFileSync(e,{encoding:"UTF-8"})}function initExtraction(e){return{srcPath:`${process.cwd()}/${e}`,keys:{__global:{}},fileCount:0}}function performTSExtraction({file:e,scopes:s,defaultValue:t,keepFlat:r,keys:a}){const l=readFile(e);if(!l.includes("@ngneat/transloco"))return a;const n=regexs.serviceInjection.exec(l);if(n){a=iterateRegex({rgx:regexs.translationCalls(n.groups.serviceName),keys:a,str:l,keepFlat:r,scopes:s,defaultValue:t})}if(regexs.directImport.exec(l)){a=iterateRegex({rgx:regexs.directTranslate,keys:a,str:l,keepFlat:r,scopes:s,defaultValue:t})}return a}function extractTSKeys({src:e,keepFlat:s=[],scopes:t,defaultValue:r,files:a}){let{srcPath:l,keys:n,fileCount:o}=initExtraction(e);return new Promise(e=>{if(a){for(const e of a)o++,n=performTSExtraction({file:e,defaultValue:r,keepFlat:s,scopes:t,keys:n});e({keys:n,fileCount:o})}else find.eachfile(/\.ts$/,l,e=>{e.endsWith(".spec.ts")||(o++,n=performTSExtraction({file:e,defaultValue:r,keepFlat:s,scopes:t,keys:n}))}).end(()=>{e({keys:n,fileCount:o})})})}function insertValueToKeys({inner:e,keys:s,scopes:t,key:r,defaultValue:a}){const l=e.length?buildObjFromPath(e,a):a,n=t.keysMap[r];n?(s[n]||(s[n]={}),s[n]=s[n]&&isObject(l)?mergeDeep(s[n],l):l):s.__global[r]=s.__global[r]&&isObject(l)?mergeDeep(s.__global[r],l):l}function performTemplateExtraction({file:e,scopes:s,defaultValue:t,keepFlat:r,keys:a}){const l=readFile(e);if(!l.includes("transloco"))return a;let n;return[regexs.structural,regexs.template].forEach((e,r)=>{for(n=e.exec(l);n;){const{scopeKeys:o,read:c,varName:i}=getTemplateBasedKeys(n,r);o&&o.forEach(e=>{let[r,...l]=e.trim().replace(/\[/g,".").replace(/'|"|\]/g,"").replace(`${i}.`,"").split(".");c&&(l.unshift(r),r=c),insertValueToKeys({inner:l,scopes:s,keys:a,key:r,defaultValue:t})}),n=e.exec(l)}}),[regexs.directive,regexs.directiveTernary,regexs.pipe].forEach(e=>{a=iterateRegex({rgx:e,keys:a,str:l,keepFlat:r,scopes:s,defaultValue:t})}),a}function extractTemplateKeys({src:e,keepFlat:s=[],scopes:t,defaultValue:r,files:a}){let{srcPath:l,keys:n,fileCount:o}=initExtraction(e);return new Promise(e=>{if(a){for(const e of a)o++,n=performTemplateExtraction({file:e,defaultValue:r,keepFlat:s,scopes:t,keys:n});e({keys:n,fileCount:o})}else find.eachfile(/\.html$/,l,e=>{o++,n=performTemplateExtraction({file:e,defaultValue:r,keepFlat:s,scopes:t,keys:n})}).end(()=>{e({keys:n,fileCount:o})})})}function iterateRegex({rgx:e,keys:s,str:t,keepFlat:r,scopes:a,defaultValue:l}){let n=e.exec(t);for(;n;){const o=n.groups.key.replace(/'|"|\s/g,"").split(":");for(const e of o){const[t,...o]=e.split(".");r.includes(t)?s[n.groups.key]=l:insertValueToKeys({inner:o,scopes:a,keys:s,key:t,defaultValue:l})}n=e.exec(t)}return s}function createJson(e,s){fs.writeFileSync(e,s,"utf8")}function verifyOutputDir(e,s){const t=s.filter(e=>"__global"!==e);fs.existsSync(e)||fs.mkdirSync(e,{recursive:!0});for(const s of t)fs.existsSync(`${e}/${s}`)||fs.mkdirSync(`${e}/${s}`,{recursive:!0})}function createFiles({keys:e,langs:s,outputPath:t}){logger.startSpinner(`${messages.creatingFiles} 🗂`);const r=Object.keys(e),a=s.split(",").map(e=>e.trim());let l=r.reduce((e,s)=>(a.forEach(r=>{const a="__global"===s?t:`${t}/${s}`;e.push(`${a}/${r}.json`)}),e),[]);verifyOutputDir(t,r);const n=glob.sync(`${t}/**/*.json`);if(n.length)for(const s of n){const{scope:r}=regexs.fileLang(t).exec(s).groups;l=l.filter(e=>e!==s);const a=readFile(s),n=mergeDeep({},r?e[r]:e.__global,JSON.parse(a));fs.writeFileSync(s,JSON.stringify(n,null,2),{encoding:"UTF-8"})}l.length&&l.forEach(s=>{const{scope:r}=regexs.fileLang(t).exec(s).groups,a=r?r.slice(0,-1):"__global";createJson(s,JSON.stringify(e[a],null,2))}),logger.succeed(),n.length&&logger.succeed(messages.merged(n)),logger.log(`\n              🌵 ${messages.done} 🌵`)}function buildKeys(e){return Promise.all([extractTemplateKeys(e),extractTSKeys(e)]).then(([e,s])=>{const t=mergeDeep({},e.keys,s.keys);return Promise.resolve({keys:t,fileCount:e.fileCount+s.fileCount})})}function getScopesMap(e){if(!e)return{keysMap:{}};const s=readFile(`${process.cwd()}/${e}`),t=/scopeMapping[\s\r\t\n]*:[\s\r\t\n]*(?<scopes>{[^}]*})/g.exec(s);let r="{}";t&&(r=t.groups.scopes);const a=r.trim().replace(/'/g,'"'),l=JSON.parse(`${a}`);return{keysMap:Object.keys(l).reduce((e,s)=>{return e[toCamelCase(l[s])]=s,e},{})}}function initProcessParams(e,s){const t=e.src||s.src||defaultConfig.src,r=e.langs||s.langs||defaultConfig.langs,a=e.defaultValue||s.defaultValue||defaultConfig.defaultValue;let l=e.output||s.output||defaultConfig.output;l=l.endsWith("/")?l.slice(0,-1):l;const n=getScopesMap(e.configPath||s.configPath);let o=e.keepFlat||s.keepFlat;return{src:t,langs:r,defaultValue:a,output:l,scopes:n,keepFlat:o=o?o.split(",").map(e=>e.trim()):[]}}function buildTranslationFiles({config:e,basePath:s}){return logger=getLogger(e.prodMode),inquirer.prompt(e.interactive?queries(s):[]).then(s=>{const{src:t,langs:r,defaultValue:a,output:l,scopes:n,keepFlat:o}=initProcessParams(s,e);return logger.log("[4m%s[0m",`\n${messages.startBuild(r.length)} 👷🏗\n`),logger.startSpinner(`${messages.extract} 🗝`),buildKeys({src:t,keepFlat:o,scopes:n,defaultValue:a}).then(({keys:e,fileCount:s})=>{logger.succeed(`${messages.extract} 🗝`);const t=countKeysRecursively(e)-Object.keys(e).length;logger.log(`${messages.keysFound(t,s)}`),createFiles({keys:e,langs:r,outputPath:`${process.cwd()}/${l}`})})}).catch(e=>logger.log(e))}module.exports={buildTranslationFiles:buildTranslationFiles,buildKeys:buildKeys,getScopesMap:getScopesMap,readFile:readFile,initProcessParams:initProcessParams,extractTemplateKeys:extractTemplateKeys,extractTSKeys:extractTSKeys};
